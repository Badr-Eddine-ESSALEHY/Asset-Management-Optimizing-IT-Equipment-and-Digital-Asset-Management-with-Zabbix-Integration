<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Messaging{% endblock %} - Asset Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    {% load static %}
    <link href="{% static 'messages/css/messages.css' %}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'pages:dashboard' %}">
                <i class="fas fa-cogs"></i> Asset Management
            </a>

            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'messages:dashboard' %}">
                    <i class="fas fa-comments"></i> Messages
                    <span id="unread-badge" class="badge bg-danger ms-1">0</span>
                </a>
                <a class="nav-link" href="{% url 'messages:notifications' %}">
                    <i class="fas fa-bell"></i> Notifications
                </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i> {{ user.username }}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'members:profile' %}">Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="{% url 'logout' %}">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </div>

    <!-- WebSocket Connection -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // WebSocket setup for real-time messaging
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/messages/`;

        let socket = null;

        function connectWebSocket() {
            socket = new WebSocket(wsUrl);

            socket.onopen = function(e) {
                console.log('WebSocket connected');
                document.querySelector('#connection-status')?.classList.remove('text-danger');
                document.querySelector('#connection-status')?.classList.add('text-success');
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                handleWebSocketMessage(data);
            };

            socket.onclose = function(e) {
                console.log('WebSocket disconnected');
                document.querySelector('#connection-status')?.classList.remove('text-success');
                document.querySelector('#connection-status')?.classList.add('text-danger');

                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };
        }

        function handleWebSocketMessage(data) {
            switch(data.type) {
                case 'new_message':
                    handleNewMessage(data.message);
                    break;
                case 'system_notification':
                    handleSystemNotification(data.notification);
                    break;
                case 'unread_count':
                    updateUnreadBadge(data.count);
                    break;
            }
        }

        function handleNewMessage(message) {
            // Update unread badge
            const badge = document.getElementById('unread-badge');
            if (badge) {
                const currentCount = parseInt(badge.textContent) || 0;
                badge.textContent = currentCount + 1;
                badge.style.display = 'inline';
            }

            // Show toast notification
            showToast('New Message', `${message.sender.username}: ${message.content.substring(0, 50)}...`, 'info');
        }

        function handleSystemNotification(notification) {
            showToast(notification.title, notification.message, 'warning');
        }

        function updateUnreadBadge(count) {
            const badge = document.getElementById('unread-badge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline' : 'none';
            }
        }

        function showToast(title, message, type) {
            // Create toast HTML
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${title}</strong><br>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            // Add to toast container
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
                document.body.appendChild(container);
            }

            container.appendChild(toast);

            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // Remove after hiding
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // Connect when page loads
        document.addEventListener('DOMContentLoaded', connectWebSocket);
    </script>

    {% block extra_js %}
    {% endblock %}
</body>
</html>